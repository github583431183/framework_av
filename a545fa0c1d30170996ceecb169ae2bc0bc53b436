{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "80f7a775_6ac82dd7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003259
      },
      "writtenOn": "2023-11-10T10:42:33Z",
      "side": 1,
      "message": "Given the size of this \"workaround\", isn\u0027t it simpler to force a legacy remote submix input device connection in audio policy manager after parsing the audio policy config and if no legacy remote submix in is attached?",
      "revId": "a545fa0c1d30170996ceecb169ae2bc0bc53b436",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c226c48d_fb196a6b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1042638
      },
      "writtenOn": "2023-11-10T18:19:06Z",
      "side": 1,
      "message": "The auto connection part is just a handful of lines in `AudioPolicyConfig.cpp`. Technically, this code is part of the APM.\n\nInitially, I tried doing just this, however I found that when both the \"template device port\" (with no address and dynamic profiles), and the connected device port (with address and profiles) are both visible to APM, it tends to pick just one randomly for \"Supported devices.\" If it ends up to be the template port, then APM never matches it when looking for the device because remote submix \"distinguishes on address.\" I now realized that the concept of the \"template device port\" did not exist before in APM, I think it \"attaches\" the template port instead, and then \"detaches\" it on device disconnection. This discrepancy is not really important for other removable devices because currently only remote submix and bus devices are marked as \"distinguishes on address.\"\n\nAnd, I don\u0027t want to change any logic in the APM besides trivial safe fixes. Our idea was that all discrepancies between HIDL and AIDL behavior are handled at the libaudiohal level.",
      "parentUuid": "80f7a775_6ac82dd7",
      "revId": "a545fa0c1d30170996ceecb169ae2bc0bc53b436",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "77c83dbc_5efe6820",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003259
      },
      "writtenOn": "2023-11-13T08:33:38Z",
      "side": 1,
      "message": "Thanks for the explanation.\n\nI would like to discuss the observation \"pick just one randomly for \"Supported devices.\"\". In which context exactly? If this was true in all context, we would have a problem to match a specific remote submix device when more than one dynamic audio policy mixes are installed, each with a different address.\nWe could merge this CL as is but I would like to understand better/fix any discrepancy between the handling of detachable devices that distinguish on address and others.",
      "parentUuid": "c226c48d_fb196a6b",
      "revId": "a545fa0c1d30170996ceecb169ae2bc0bc53b436",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a2f4c8c9_5b883d29",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1042638
      },
      "writtenOn": "2023-11-13T17:14:26Z",
      "side": 1,
      "message": "Sure. This is the example of the dump that I observed when libaudiohal@aidl does not \"hide\" the \"template device port\" (no address, dynamic profiles) from the APM.\n\nFirst, the expected dump which happens sometimes:\n\n```\n   - Input MixPorts (1):\n      1. \"r_submix input\"; 0x0000 (AUDIO_INPUT_FLAG_NONE)\n       - Profiles (1):\n          1. \"\"; AUDIO_FORMAT_PCM_16_BIT (0x1)\n             sampling rates: 8000, 11025, 16000, 32000, 44100, 48000\n             channel masks: 0x000c, 0x0010\n             AUDIO_ENCAPSULATION_TYPE_NONE\n       - Supported devices (1):\n\u003e\u003e\u003e       1. \"Remote Submix In\"; {AUDIO_DEVICE_IN_REMOTE_SUBMIX, @:0}\n           Encapsulation modes: 0, metadata types: 0\n       - maxOpenCount: 20; curOpenCount: 0\n       - maxActiveCount: 10; curActiveCount: 0\n       - recommendedMuteDurationMs: 0 ms\n   - Declared devices (3):\n    1. \"Remote Submix Out\"; {AUDIO_DEVICE_OUT_REMOTE_SUBMIX, @:}\n       Encapsulation modes: 0, metadata types: 0\n     - Profiles (1):\n        1. \"\"; [dynamic format][dynamic channels][dynamic rates]; AUDIO_FORMAT_DEFAULT (0x0)\n           AUDIO_ENCAPSULATION_TYPE_NONE\n    2. \"Remote Submix In\"; {AUDIO_DEVICE_IN_REMOTE_SUBMIX, @:0}\n       Encapsulation modes: 0, metadata types: 0\n     - Profiles (1):\n        1. \"\"; AUDIO_FORMAT_PCM_16_BIT (0x1)\n           sampling rates: 8000, 11025, 16000, 32000, 44100, 48000\n           channel masks: 0x000c, 0x0010\n           AUDIO_ENCAPSULATION_TYPE_NONE\n    3. \"Remote Submix In\"; {AUDIO_DEVICE_IN_REMOTE_SUBMIX, @:}\n       Encapsulation modes: 0, metadata types: 0\n     - Profiles (1):\n        1. \"\"; [dynamic format][dynamic channels][dynamic rates]; AUDIO_FORMAT_DEFAULT (0x0)\n           AUDIO_ENCAPSULATION_TYPE_NONE\n   - Audio Routes (2):\n      1. Mix; Sink: \"Remote Submix Out\"\n         Sources: \"r_submix output\"\n      2. Mix; Sink: \"r_submix input\"\n         Sources: \"Remote Submix In\", \"Remote Submix In\"\n```\n\nSecond, the dump which also happens sometimes, where \"Supported devices\" picks up the \"template device port\":\n\n```\n   - Input MixPorts (1):\n      1. \"r_submix input\"; 0x0000 (AUDIO_INPUT_FLAG_NONE)\n       - Profiles (1):\n          1. \"\"; AUDIO_FORMAT_PCM_16_BIT (0x1)\n             sampling rates: 8000, 11025, 16000, 32000, 44100, 48000\n             channel masks: 0x000c, 0x0010\n             AUDIO_ENCAPSULATION_TYPE_NONE\n       - Supported devices (1):\n\u003e\u003e\u003e       1. \"Remote Submix In\"; {AUDIO_DEVICE_IN_REMOTE_SUBMIX, @:}\n           Encapsulation modes: 0, metadata types: 0\n       - maxOpenCount: 20; curOpenCount: 0\n       - maxActiveCount: 10; curActiveCount: 0\n       - recommendedMuteDurationMs: 0 ms\n   - Declared devices (3):\n    1. \"Remote Submix Out\"; {AUDIO_DEVICE_OUT_REMOTE_SUBMIX, @:0}\n       Encapsulation modes: 0, metadata types: 0\n     - Profiles (1):\n        1. \"\"; [dynamic format][dynamic channels][dynamic rates]; AUDIO_FORMAT_DEFAULT (0x0)\n           AUDIO_ENCAPSULATION_TYPE_NONE\n    2. \"Remote Submix In\"; {AUDIO_DEVICE_IN_REMOTE_SUBMIX, @:}\n       Encapsulation modes: 0, metadata types: 0\n     - Profiles (1):\n        1. \"\"; [dynamic format][dynamic channels][dynamic rates]; AUDIO_FORMAT_DEFAULT (0x0)\n           AUDIO_ENCAPSULATION_TYPE_NONE\n    3. \"Remote Submix In\"; {AUDIO_DEVICE_IN_REMOTE_SUBMIX, @:0}\n       Encapsulation modes: 0, metadata types: 0\n     - Profiles (1):\n        1. \"\"; AUDIO_FORMAT_PCM_16_BIT (0x1)\n           sampling rates: 8000, 11025, 16000, 32000, 44100, 48000\n           channel masks: 0x000c, 0x0010\n           AUDIO_ENCAPSULATION_TYPE_NONE\n   - Audio Routes (2):\n      1. Mix; Sink: \"Remote Submix Out\"\n         Sources: \"r_submix output\"\n      2. Mix; Sink: \"r_submix input\"\n         Sources: \"Remote Submix In\", \"Remote Submix In\"\n```\n\nIt seems that the first port in the list of \"Declared devices\" gets picked.\n\nThe situation when only the \"template device port\" is in the list of supported devices is problematic as APM can\u0027t choose it because r_submix \"distinguishes on address\", this an input for \"R_SUBMIX @0\" can\u0027t be found which results in a failure when opening a stream.",
      "parentUuid": "77c83dbc_5efe6820",
      "revId": "a545fa0c1d30170996ceecb169ae2bc0bc53b436",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}