{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "88c99eee_c29a4d79",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1047003
      },
      "writtenOn": "2021-11-18T02:19:19Z",
      "side": 1,
      "message": "Andy,\nAs discussed, I verified that by setting volume before enabling effects, fixes the volume surge seen.\nBut I am not sure if this is the right way to fix it.\nCan you please take a look?\nThanks.",
      "revId": "d78d3e5cc3f1ad198d530a93185aa8336d2d455a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "46e9605e_0830c47c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2021-12-09T18:58:24Z",
      "side": 1,
      "message": "Harish, just a ping to see if you can help check whether obtaining the chain lock in AudioFlinger::moveEffectChain_l() can resolve the race condition without changing Effects.cpp?",
      "revId": "d78d3e5cc3f1ad198d530a93185aa8336d2d455a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4efc9254_5e2599f2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1047003
      },
      "writtenOn": "2021-12-10T01:12:35Z",
      "side": 1,
      "message": "Andy,\nSince I had flashed my device to aosp/master for some other tests, I flashed a sc-release build and installed yt music today and tried to reproduce the original issue. With this I am no longer able to reproduce the original glitch in volume at the start of playback when the app plays a single file in a loop. Are the other fixes w.r.t. session id merged and that is making it harder to reproduce the issue?",
      "parentUuid": "46e9605e_0830c47c",
      "revId": "d78d3e5cc3f1ad198d530a93185aa8336d2d455a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2c438617_ee543281",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2022-01-27T20:12:27Z",
      "side": 1,
      "message": "Harish, I\u0027m not able to reproduce this issue either (just checked this week).  However, I think we should obtain the chain lock when starting the effect in moveEffectChain_l().",
      "revId": "d78d3e5cc3f1ad198d530a93185aa8336d2d455a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f19113d0_4f3cae97",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 5
      },
      "lineNbr": 1104,
      "author": {
        "id": 1003259
      },
      "writtenOn": "2021-12-01T08:55:38Z",
      "side": 1,
      "message": "Do we still need to call this twice?",
      "range": {
        "startLine": 1104,
        "startChar": 0,
        "endLine": 1104,
        "endChar": 37
      },
      "revId": "d78d3e5cc3f1ad198d530a93185aa8336d2d455a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "12cb5680_b0e0c991",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 5
      },
      "lineNbr": 1104,
      "author": {
        "id": 1003259
      },
      "writtenOn": "2021-12-01T09:27:52Z",
      "side": 1,
      "message": "If this fixes the problem it means we are in a context of an active effects moved to a new effect chain by  AudioFlinger::moveEffectChain_l() because it is the only place where start() is called (we cannot be in  moveAuxEffectToIo() because we are not using aux effects).\nThe normal way to enable an effect is from EffectChain::process_l() if updateState() indicates we started the effect and we should probably also call resetVolume() before starting the effect in this context. But this is more complex as we cannot call the callback with the EffectModule mutex held.\n\nOne option is to set mSetVolumeReentrantTid \u003d gettid(); before and reset it after and call  getCallback()-\u003eresetVolume() in EffectVolume::start_l()",
      "parentUuid": "f19113d0_4f3cae97",
      "range": {
        "startLine": 1104,
        "startChar": 0,
        "endLine": 1104,
        "endChar": 37
      },
      "revId": "d78d3e5cc3f1ad198d530a93185aa8336d2d455a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "56d977c5_957e9fe2",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 5
      },
      "lineNbr": 1104,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2021-12-01T18:28:36Z",
      "side": 1,
      "message": "Interesting analysis - perhaps the comment on line 1093 is incorrect.  We need to have the EffectChain::mLock held while calling EffectModule::start() because it may be currently processing.  Simply having the PlaybackThread::mLock is insufficient.\n\nPerhaps we should rearrange the logic here in AudioFlinger::moveEffectChain_l()\n\nhttps://cs.android.com/android/platform/superproject/+/master:frameworks/av/services/audioflinger/AudioFlinger.cpp;drc\u003d33223031bc31ca094ca4960cb6cf20ef266834c4;l\u003d3996\n\nto call the EffectModule::start() with the effect chain lock.  With some more modification (i.e. passing the changed effects to the caller, or provide a thunk to do so), we could reenable after all thread locks are released, but that probably is not needed.\n\nTo be honest, I\u0027d like to remove volume control altogether now that we are processing in float.  But that might be a later change.",
      "parentUuid": "12cb5680_b0e0c991",
      "range": {
        "startLine": 1104,
        "startChar": 0,
        "endLine": 1104,
        "endChar": 37
      },
      "revId": "d78d3e5cc3f1ad198d530a93185aa8336d2d455a",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}