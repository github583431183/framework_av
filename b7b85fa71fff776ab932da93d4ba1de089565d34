{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "704888b3_e2607a3d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1643016
      },
      "writtenOn": "2023-11-13T12:08:53Z",
      "side": 1,
      "message": "Do you have a bug that describes how to reproduce this problem exactly? \n\nPlease also note that the scaling mode shouldn\u0027t be set when configuring the codec but only when receiving output buffers. See https://developer.android.com/reference/android/media/MediaCodec#setVideoScalingMode(int) where this is explained on the codec Java APIs.",
      "revId": "b7b85fa71fff776ab932da93d4ba1de089565d34",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0f7166c4_343b055e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 2067060
      },
      "writtenOn": "2023-11-15T12:51:53Z",
      "side": 1,
      "message": "when playing video through mediaplayer, setting the scaling mode to SCALE_TO_FIT_WITH_CROPPING,and the content and surface have different aspect ratios;\nBug:the first few frames are streteched, and the remaining frames are cropped to fit the surface;\nExpectation: all frames are cropped to fit the surface;\nWhen the app calls setVideoScalingMode, and neither the surface nor the decoder is ready, scaling mode cannot be set to MediaCodec. Until MediaCodec receives outputFormatChanged, NuPlayer begins to set scaling mode through setParams. Before it takes effect,MediaCodec has decoded and rendered some frames, and these frames are stretched for display",
      "parentUuid": "704888b3_e2607a3d",
      "revId": "b7b85fa71fff776ab932da93d4ba1de089565d34",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8ab04a20_77ba87b2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1643016
      },
      "writtenOn": "2023-11-16T09:40:53Z",
      "side": 1,
      "message": "\u003e Until MediaCodec receives outputFormatChanged, NuPlayer begins to set scaling mode through setParams\n\nI assume you are referring to the call on L1151? \n\n@wonsik@google.com / @lajos@google.com: Based on previous guidance, calling this method after a change in output format was considered the correct timing (see [internal: b/28131249#comment6]) and this is also how it\u0027s documented on the MediaCodec Java API. But this change attempts to set it earlier while instantiating a codec (which also looks sensible). Has something changed that requires setting the scaling mode earlier again?",
      "parentUuid": "0f7166c4_343b055e",
      "revId": "b7b85fa71fff776ab932da93d4ba1de089565d34",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8aafaebd_5d4bb9ae",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 2067060
      },
      "writtenOn": "2023-11-17T12:08:34Z",
      "side": 1,
      "message": "Nothing has changed.As mentioned before,app calls setVideoScalingMode after setDataSource(https://developer.android.com/reference/android/media/MediaPlayer#setVideoScalingMode(int)),expeting to crop the content to fit the surface. But,because the codec is NULL(L2229),until outputFormatChanged, the scaling mode is set to the app\u0027s expected(NATIVE_WINDOW_SCALING_MODE_SCALE_CROP), and it was the default value(VIDEO_SCALING_MODE_SCALE_TO_FIT) before that. Therefore, it is necessary to synchronize the value to the decoder instance when instantiating a codec , ensure that all frames are cropped to fit the surface.",
      "parentUuid": "8ab04a20_77ba87b2",
      "revId": "b7b85fa71fff776ab932da93d4ba1de089565d34",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d82274f5_ce7880d0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1018606
      },
      "writtenOn": "2023-11-17T21:14:50Z",
      "side": 1,
      "message": "There\u0027s a mention of \"before the release of any new buffers\" and from the description it sounds like the frames can render before the scaling mode is set.",
      "parentUuid": "8aafaebd_5d4bb9ae",
      "revId": "b7b85fa71fff776ab932da93d4ba1de089565d34",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cb0a4754_34959888",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1643016
      },
      "writtenOn": "2023-11-21T11:24:25Z",
      "side": 1,
      "message": "\u003e from the description it sounds like the frames can render before the scaling mode is set.\n\nYes, this seems to be the issue. Looks like the underlying problem is that NuPlayerDecoder sends a message when the output size changed (which is handled here and then the parameter change sends another message). But in the meantime, NuPlayerDecoder can release buffers with the wrong scaling mode.\n\nThe fix here looks fairly safe because it only sets a parameter that will be set anyway a short time later so we can accept it as it is.",
      "parentUuid": "d82274f5_ce7880d0",
      "revId": "b7b85fa71fff776ab932da93d4ba1de089565d34",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}