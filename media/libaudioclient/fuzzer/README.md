# Fuzzer for libaudioflinger

## Plugin Design Considerations
The fuzzer plugin for libaudioflinger is designed based on the understanding of the
library and tries to achieve the following:

##### Maximize code coverage
The configuration parameters are not hardcoded, but instead selected based on
incoming data. This ensures more code paths are reached by the fuzzer.

libaudioflinger supports the following parameters:
1. Unique IDs (parameter name: `uniqueId`)
2. Audio Stream Type (parameter name: `streamType`)
3. Audio Mode (parameter name: `audioMode`)
4. Audio Format (parameter name: `format`)
5. Audio Channel Mask (parameter name: `channelMask`)
6. Record Channel Mask (parameter name: `recordChannelMask`)
7. Input Flags (parameter name: `inputFlags`)
8. Output Flags (parameter name: `outputFlags`)
9. Session ID (parameter name: `sessionId`)
10. Usage (parameter name: `usage`)
11. Audio Content Type (parameter name: `contentType`)
12. Input Source (parameter name: `inputSource`)
13. Encapsulation Mode (parameter name: `encapsulationMode`)
14. Audio Device (parameter name: `audioDevice`)
15. Audio Source (parameter name: `audioSource`)
16. Audio Input Flag (parameter name: `audioInputFlag`)
17. Audio Port Role (parameter name: `audioPortRole`)
18. Audio Port Type (parameter name: `audioPortType`)
19. Audio Gain Mode (parameter name: `audioGainMode`)

| Parameter| Valid Values| Configured Value|
|------------- |-------------| ----- |
| `uniqueId` | 0. `AUDIO_UNIQUE_ID_USE_UNSPECIFIED` 1. `AUDIO_UNIQUE_ID_USE_SESSION`2. `AUDIO_UNIQUE_ID_USE_MODULE` 3. `AUDIO_UNIQUE_ID_USE_EFFECT` 4. `AUDIO_UNIQUE_ID_USE_PATCH` 5. `AUDIO_UNIQUE_ID_USE_OUTPUT` 6. `AUDIO_UNIQUE_ID_USE_INPUT` 7. `AUDIO_UNIQUE_ID_USE_CLIENT` 8. `AUDIO_UNIQUE_ID_USE_MAX` 9. `AUDIO_UNIQUE_ID_USE_MASK` | Value obtained from FuzzedDataProvider
| `streamType`   |  0. `AUDIO_STREAM_VOICE_CALL` 1. `AUDIO_STREAM_SYSTEM` 2. `AUDIO_STREAM_RING` 3. `AUDIO_STREAM_MUSIC` 4. `AUDIO_STREAM_ALARM` 5. ` AUDIO_STREAM_NOTIFICATION` 6. `AUDIO_STREAM_BLUETOOTH_SCO` 7. `AUDIO_STREAM_ENFORCED_AUDIBLE` 8. `AUDIO_STREAM_DTMF` 9. `AUDIO_STREAM_TTS` 10. `AUDIO_STREAM_ACCESSIBILITY` 11. `AUDIO_STREAM_ASSISTANT` 12. `AUDIO_STREAM_REROUTING` 13. `AUDIO_STREAM_PATCH` 14. `AUDIO_STREAM_CALL_ASSISTANT` | Value obtained from FuzzedDataProvider|
| `audioMode`   | 0.`AUDIO_MODE_INVALID` 1. `AUDIO_MODE_CURRENT` 2. ` AUDIO_MODE_NORMAL` 3. `AUDIO_MODE_RINGTONE` 4. `AUDIO_MODE_IN_CALL` 5. `AUDIO_MODE_IN_COMMUNICATION` 6. `AUDIO_MODE_CALL_SCREEN`| Value obtained from FuzzedDataProvider|
| `format`   | 0.`AUDIO_FORMAT_PCM_16_BIT` 1. `AUDIO_FORMAT_PCM_8_BIT` 2. ` AUDIO_FORMAT_PCM_32_BIT` 3. `AUDIO_FORMAT_PCM_FLOAT`| Value obtained from FuzzedDataProvider|
| `channelMask`   | 0.`AUDIO_CHANNEL_OUT_STEREO` 1. `AUDIO_CHANNEL_OUT_MONO` 2. `AUDIO_CHANNEL_OUT_5POINT1` 3. `AUDIO_CHANNEL_OUT_7POINT1`| Value obtained from FuzzedDataProvider|
| `recordChannelMask`   | 0.`AUDIO_CHANNEL_IN_MONO` 1. `AUDIO_CHANNEL_IN_STEREO`| Value obtained from FuzzedDataProvider|
| `inputFlags`   | 0. `AUDIO_INPUT_FLAG_NONE` 1. `AUDIO_INPUT_FLAG_FAST` 2. `AUDIO_INPUT_FLAG_HW_HOTWORD` 3. `AUDIO_INPUT_FLAG_RAW` 4. `AUDIO_INPUT_FLAG_SYNC` 5. `AUDIO_INPUT_FLAG_MMAP_NOIRQ` 6. `AUDIO_INPUT_FLAG_VOIP_TX` 7. `AUDIO_INPUT_FLAG_HW_AV_SYNC` 8. `AUDIO_INPUT_FLAG_DIRECT`| Value obtained from FuzzedDataProvider|
| `outputFlags`   | 0. `AUDIO_OUTPUT_FLAG_NONE` 1. `AUDIO_OUTPUT_FLAG_DIRECT` 2. `AUDIO_OUTPUT_FLAG_PRIMARY` 3. `AUDIO_OUTPUT_FLAG_FAST` 4. `AUDIO_OUTPUT_FLAG_DEEP_BUFFER` 5. `AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD` 6. `AUDIO_OUTPUT_FLAG_NON_BLOCKING` 7. `AUDIO_OUTPUT_FLAG_HW_AV_SYNC` 8. `AUDIO_OUTPUT_FLAG_TTS` 9. `AUDIO_OUTPUT_FLAG_RAW` 10. `AUDIO_OUTPUT_FLAG_SYNC` 11. `AUDIO_OUTPUT_FLAG_IEC958_NONAUDIO` 12. `AUDIO_OUTPUT_FLAG_DIRECT_PCM` 13. `AUDIO_OUTPUT_FLAG_MMAP_NOIRQ` 14. `AUDIO_OUTPUT_FLAG_VOIP_RX` 15. `AUDIO_OUTPUT_FLAG_INCALL_MUSIC`| Value obtained from FuzzedDataProvider|
| `sessionId`   | 0. `AUDIO_SESSION_NONE` 1. `AUDIO_SESSION_OUTPUT_STAGE` 2. `AUDIO_SESSION_DEVICE`| Value obtained from FuzzedDataProvider|
| `usage`   | 0. `AUDIO_USAGE_UNKNOWN` 1. `AUDIO_USAGE_MEDIA` 2. `AUDIO_USAGE_VOICE_COMMUNICATION` 3. `AUDIO_USAGE_VOICE_COMMUNICATION_SIGNALLING` 4. `AUDIO_USAGE_ALARM` 5. `AUDIO_USAGE_NOTIFICATION` 6. `AUDIO_USAGE_NOTIFICATION_TELEPHONY_RINGTONE` 7. `AUDIO_USAGE_NOTIFICATION_COMMUNICATION_REQUEST` 8. `AUDIO_USAGE_NOTIFICATION_COMMUNICATION_INSTANT` 9. `AUDIO_USAGE_NOTIFICATION_COMMUNICATION_DELAYED` 10. `AUDIO_USAGE_NOTIFICATION_EVENT` 11. `AUDIO_USAGE_ASSISTANCE_ACCESSIBILITY` 12. `AUDIO_USAGE_ASSISTANCE_NAVIGATION_GUIDANCE` 13. `AUDIO_USAGE_ASSISTANCE_SONIFICATION` 14. `AUDIO_USAGE_GAME` 15. `AUDIO_USAGE_VIRTUAL_SOURCE` 16. `AUDIO_USAGE_ASSISTANT` 17. `AUDIO_USAGE_CALL_ASSISTANT` 18. `AUDIO_USAGE_EMERGENCY` 19. `AUDIO_USAGE_SAFETY` 20. `AUDIO_USAGE_VEHICLE_STATUS` 21. `AUDIO_USAGE_ANNOUNCEMENT`| Value obtained from FuzzedDataProvider|
| `contentType`   | 0. `AUDIO_CONTENT_TYPE_UNKNOWN` 1. `AUDIO_CONTENT_TYPE_SPEECH` 2. `AUDIO_CONTENT_TYPE_MUSIC` 3. `AUDIO_CONTENT_TYPE_MOVIE` 4. `AUDIO_CONTENT_TYPE_SONIFICATION`| Value obtained from FuzzedDataProvider|
| `inputSource`   | 0. `AUDIO_SOURCE_DEFAULT` 1. `AUDIO_SOURCE_MIC` 2. `AUDIO_SOURCE_VOICE_UPLINK` 3. `AUDIO_SOURCE_VOICE_DOWNLINK` 4. `AUDIO_SOURCE_VOICE_CALL` 5. `AUDIO_SOURCE_CAMCORDE` 6. `AUDIO_SOURCE_VOICE_RECOGNITION` 7. `AUDIO_SOURCE_VOICE_COMMUNICATION` 8. `AUDIO_SOURCE_REMOTE_SUBMIX` 9. `AUDIO_SOURCE_UNPROCESSED` 10. `AUDIO_SOURCE_VOICE_PERFORMANCE`  11. `AUDIO_SOURCE_ECHO_REFERENCE` 12. `AUDIO_SOURCE_FM_TUNER`| Value obtained from FuzzedDataProvider|
| `encapsulationMode`   | 0. `AUDIO_ENCAPSULATION_MODE_NONE` 1. `AUDIO_ENCAPSULATION_MODE_ELEMENTARY_STREAM` 2. `AUDIO_ENCAPSULATION_MODE_HANDLE`| Value obtained from FuzzedDataProvider|
| `audioDevice`   | 0. `AUDIO_DEVICE_NONE` 1. `AUDIO_DEVICE_OUT_EARPIECE` 2. `AUDIO_DEVICE_OUT_SPEAKER` 3. `AUDIO_DEVICE_OUT_WIRED_HEADSET` 4. `AUDIO_DEVICE_OUT_WIRED_HEADPHONE` 5. `AUDIO_DEVICE_OUT_BLUETOOTH_SCO` 6. `AUDIO_DEVICE_OUT_BLUETOOTH_SCO_HEADSET` 7.`AUDIO_DEVICE_OUT_BLUETOOTH_SCO_CARKIT` 8. `AUDIO_DEVICE_OUT_BLUETOOTH_A2DP` 9. `AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_HEADPHONES` 10. `AUDIO_DEVICE_OUT_BLUETOOTH_A2DP_SPEAKER` 11. `AUDIO_DEVICE_OUT_HDMI` 12. `AUDIO_DEVICE_OUT_ANLG_DOCK_HEADSET` 13. `AUDIO_DEVICE_OUT_DGTL_DOCK_HEADSET` 14. `AUDIO_DEVICE_OUT_USB_ACCESSORY` 15. `AUDIO_DEVICE_OUT_USB_DEVICE` 16. `AUDIO_DEVICE_OUT_REMOTE_SUBMIX` 17. `AUDIO_DEVICE_OUT_TELEPHONY_TX` 18. `AUDIO_DEVICE_OUT_LINE` 19. `AUDIO_DEVICE_OUT_HDMI_ARC` 20. `AUDIO_DEVICE_OUT_SPDIF` 21. `AUDIO_DEVICE_OUT_FM` 22. `AUDIO_DEVICE_OUT_AUX_LINE` 23. `AUDIO_DEVICE_OUT_SPEAKER_SAFE` 24. `AUDIO_DEVICE_OUT_IP` 25. `AUDIO_DEVICE_OUT_BUS` 26. `AUDIO_DEVICE_OUT_PROXY` 27. `AUDIO_DEVICE_OUT_USB_HEADSET` 28. `AUDIO_DEVICE_OUT_HEARING_AID` 29. `AUDIO_DEVICE_OUT_ECHO_CANCELLER` 30. `AUDIO_DEVICE_OUT_BLE_HEADSET` 31. `AUDIO_DEVICE_OUT_BLE_SPEAKER` 32. `AUDIO_DEVICE_OUT_DEFAULT` 33. `AUDIO_DEVICE_IN_COMMUNICATION` 34. `AUDIO_DEVICE_IN_AMBIENT` 35. `AUDIO_DEVICE_IN_BUILTIN_MIC` 36. `AUDIO_DEVICE_IN_BLUETOOTH_SCO_HEADSET` 37. `AUDIO_DEVICE_IN_WIRED_HEADSET` 38. `AUDIO_DEVICE_IN_HDMI` 39. `AUDIO_DEVICE_IN_TELEPHONY_RX` 40. `AUDIO_DEVICE_IN_BACK_MIC` 41. `AUDIO_DEVICE_IN_REMOTE_SUBMIX` 42. `AUDIO_DEVICE_IN_ANLG_DOCK_HEADSET` 43. `AUDIO_DEVICE_IN_DGTL_DOCK_HEADSET` 44. `AUDIO_DEVICE_IN_USB_ACCESSORY` 45. `AUDIO_DEVICE_IN_USB_DEVICE` 46. `AUDIO_DEVICE_IN_FM_TUNER` 47. `AUDIO_DEVICE_IN_TV_TUNER` 48. `AUDIO_DEVICE_IN_LINE` 49. `AUDIO_DEVICE_IN_SPDIF` 50. `AUDIO_DEVICE_IN_BLUETOOTH_A2DP` 51. `AUDIO_DEVICE_IN_LOOPBACK` 52. `AUDIO_DEVICE_IN_IP` 53. `AUDIO_DEVICE_IN_BUS` 54. `AUDIO_DEVICE_IN_PROXY` 55. `AUDIO_DEVICE_IN_USB_HEADSET` 56. `AUDIO_DEVICE_IN_BLUETOOTH_BLE` 57. `AUDIO_DEVICE_IN_HDMI_ARC` 58. `AUDIO_DEVICE_IN_ECHO_REFERENCE` 59. `AUDIO_DEVICE_IN_BLE_HEADSET` 60. `AUDIO_DEVICE_IN_DEFAULT` 61. `AUDIO_DEVICE_OUT_AUX_DIGITAL` 62. `AUDIO_DEVICE_OUT_STUB` 63. `AUDIO_DEVICE_IN_VOICE_CALL` 64. `AUDIO_DEVICE_IN_AUX_DIGITAL` 65. `AUDIO_DEVICE_IN_STUB`| Value obtained from FuzzedDataProvider|
| `audioSource`   | 0. `AUDIO_SOURCE_DEFAULT` 1. `AUDIO_SOURCE_MIC` 2. `AUDIO_SOURCE_VOICE_UPLINK` 3. `AUDIO_SOURCE_VOICE_DOWNLINK` 4. `AUDIO_SOURCE_VOICE_CALL` 5. `AUDIO_SOURCE_CAMCORDER` 6. `AUDIO_SOURCE_VOICE_RECOGNITION` 7. `AUDIO_SOURCE_VOICE_COMMUNICATION` 8. `AUDIO_SOURCE_REMOTE_SUBMIX` 9. `AUDIO_SOURCE_UNPROCESSED` 10. `AUDIO_SOURCE_VOICE_PERFORMANCE` 11. `AUDIO_SOURCE_ECHO_REFERENCE` 12. `AUDIO_SOURCE_FM_TUNER` 13. `AUDIO_SOURCE_HOTWORD`| Value obtained from FuzzedDataProvider|
| `audioPortRole`   | 0. `AUDIO_PORT_ROLE_NONE` 1. `AUDIO_PORT_ROLE_SOURCE` 2. `AUDIO_PORT_ROLE_SINK`| Value obtained from FuzzedDataProvider|
| `audioPortType`   | 0. `AUDIO_PORT_TYPE_NONE` 1. `AUDIO_PORT_TYPE_DEVICE` 2. `AUDIO_PORT_TYPE_MIX` 3. `AUDIO_PORT_TYPE_SESSION`| Value obtained from FuzzedDataProvider|
| `audioGainMode`   | 0. `AUDIO_GAIN_MODE_JOINT` 1. `AUDIO_GAIN_MODE_CHANNELS` 2. `AUDIO_GAIN_MODE_RAMP` | Value obtained from FuzzedDataProvider|

This also ensures that the plugin is always deterministic for any given input.

##### Maximize utilization of input data
The plugin tolerates any kind of input (empty, huge,
malformed, etc) and doesn't `exit()` on any input and thereby increasing the
chance of identifying vulnerabilities.

## Build

This describes steps to build audioflinger_fuzzer binary.

### Android

#### Steps to build
Build the fuzzer
```
  $ mm -j$(nproc) audioflinger_fuzzer
```

#### Steps to run
Create a directory CORPUS_DIR and copy some files to that folder
Push this directory to device.

To run on device
```
  $ adb sync data
  $ adb shell /data/fuzz/arm64/audioflinger_fuzzer/audioflinger_fuzzer CORPUS_DIR
```

## References:
 * http://llvm.org/docs/LibFuzzer.html
 * https://github.co
