{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "dc00eb1a_4a718945",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1491204
      },
      "writtenOn": "2024-05-23T12:05:51Z",
      "side": 1,
      "message": "Eric, Mikhail, I got new regressions on Device Effects due to lock order enforcmenet. Not really sure it is the best way to fix... Feel free to propose.",
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "87fef968_6fd9005d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1042638
      },
      "writtenOn": "2024-05-23T17:56:30Z",
      "side": 1,
      "message": "Shunkai, since you know better how effects are handled in the AF, could you please check if you can suggest anything here?",
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "40f674be_a07dfbb3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2024-05-24T00:54:34Z",
      "side": 1,
      "message": "Ideally we can make the device effect code work with thread-safety annotations.  I have added some comments below, but am not sure on the exact call stacks which cause issues.",
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "29a86f28_d844dd1a",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 1040,
      "author": {
        "id": 1042638
      },
      "writtenOn": "2024-05-23T17:56:30Z",
      "side": 1,
      "message": "I think this is reserved for cases when there is no sane way to express mutex requirements, and when the scope of the manual mutex management is obvious. In this case we are calling into some method of another object, so we are not really in control of what happens there.\n\nI would consider re-engineering this code a bit to use `audio_utils::unique_lock` (https://cs.android.com/android/platform/superproject/main/+/main:system/media/audio_utils/include/audio_utils/mutex.h;l\u003d1566;drc\u003daead8b971fcfe6bdb30459501f9e605829f73b37) instead of `lock_guard` because the former provides `unlock()` and `lock()` methods that provide necessary information to the thread safety analysis framework.",
      "range": {
        "startLine": 1040,
        "startChar": 0,
        "endLine": 1040,
        "endChar": 25
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "09d8f39c_14b16c60",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 1040,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2024-05-24T00:54:34Z",
      "side": 1,
      "message": "Agree that we should avoid NO_THREAD_SAFETY_ANALYSIS whenever possible. In this case, the mutex().unlock() requires the mutex() to be held. I would suggest adding a REQUIRES(audio_utils::EffectBase_Mutex) or REQUIRES(mutex()) in the Effects.h declaration of addEffectToHal_l(), which should solve this.  Unfortunately, these thread safety annotations can become viral, so often more methods must be annotated for the code to compile properly.\n\nWe haven\u0027t had the time to fully clean up all of the AudioFlinger annotations.\n\nSimilar comment for removeEffectFromHal_l().",
      "parentUuid": "29a86f28_d844dd1a",
      "range": {
        "startLine": 1040,
        "startChar": 0,
        "endLine": 1040,
        "endChar": 25
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f6bdc3b2_1d1a61dd",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 1040,
      "author": {
        "id": 1491204
      },
      "writtenOn": "2024-05-24T12:29:15Z",
      "side": 1,
      "message": "NO_THREAD_SAFETY_ANALYSIS removed. I used as for today a Workaround: asynchronously add/remove device effect.\nIt is risky to try breaking the lock schema since add/remove can be added from several flow, with chain/module lock handled. \nDevice effect needs Hw lock in the end, which is expected before Chain / Module lock.\n\nHuge refactor may be needed to \"unlock\" chain/module on demand for device effect.",
      "parentUuid": "09d8f39c_14b16c60",
      "range": {
        "startLine": 1040,
        "startChar": 0,
        "endLine": 1040,
        "endChar": 25
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e1357a06_48b8eb04",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 1880,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2024-05-24T00:54:34Z",
      "side": 1,
      "message": "can the DeviceEffectManager call disconnect_l()?",
      "range": {
        "startLine": 1880,
        "startChar": 0,
        "endLine": 1880,
        "endChar": 63
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c2a6a655_bd462025",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 1880,
      "author": {
        "id": 1491204
      },
      "writtenOn": "2024-05-24T08:35:12Z",
      "side": 1,
      "message": "Not directly but when a handle is released by DeviceEffectProxy::onCreatePatch",
      "parentUuid": "e1357a06_48b8eb04",
      "range": {
        "startLine": 1880,
        "startChar": 0,
        "endLine": 1880,
        "endChar": 63
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cfecc2a8_200862a8",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 1880,
      "author": {
        "id": 1491204
      },
      "writtenOn": "2024-05-24T11:57:29Z",
      "side": 1,
      "message": "since EffectHandle destructor calls disconnect",
      "parentUuid": "c2a6a655_bd462025",
      "range": {
        "startLine": 1880,
        "startChar": 0,
        "endLine": 1880,
        "endChar": 63
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a229cd3c_75193d66",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 3324,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2024-05-24T00:54:34Z",
      "side": 1,
      "message": "mEffectHandles should be guarded by proxyMutex().  it is possible to make a copy under lock.",
      "range": {
        "startLine": 3324,
        "startChar": 28,
        "endLine": 3324,
        "endChar": 44
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4fb6af8a_66e84fed",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 3324,
      "author": {
        "id": 1491204
      },
      "writtenOn": "2024-05-24T11:57:29Z",
      "side": 1,
      "message": "lock removed by mistake",
      "parentUuid": "a229cd3c_75193d66",
      "range": {
        "startLine": 3324,
        "startChar": 28,
        "endLine": 3324,
        "endChar": 44
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0967c223_fcf2e6cc",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 3326,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2024-05-24T00:54:34Z",
      "side": 1,
      "message": "this presumes a mutex is being held... here and below.",
      "range": {
        "startLine": 3326,
        "startChar": 40,
        "endLine": 3326,
        "endChar": 51
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "168ecdae_45b54fc8",
        "filename": "services/audioflinger/Effects.cpp",
        "patchSetId": 1
      },
      "lineNbr": 3326,
      "author": {
        "id": 1491204
      },
      "writtenOn": "2024-05-24T12:24:50Z",
      "side": 1,
      "message": "proxyMutex was removed by mistake in previous patch set.",
      "parentUuid": "0967c223_fcf2e6cc",
      "range": {
        "startLine": 3326,
        "startChar": 40,
        "endLine": 3326,
        "endChar": 51
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "70e935b1_35731bd0",
        "filename": "services/audioflinger/Effects.h",
        "patchSetId": 1
      },
      "lineNbr": 331,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2024-05-24T00:54:34Z",
      "side": 1,
      "message": "please annotate REQUIRES(audio_utils::EffectHandle_Mutex) here.",
      "range": {
        "startLine": 331,
        "startChar": 21,
        "endLine": 331,
        "endChar": 30
      },
      "fixSuggestions": [
        {
          "fixId": "9f95aaac_67b3f628",
          "description": "prompt_to_edit API",
          "replacements": [
            {
              "path": "services/audioflinger/Effects.h",
              "range": {
                "startLine": 331,
                "startChar": 0,
                "endLine": 333,
                "endChar": 0
              },
              "replacement": "    status_t enable_l() final REQUIRES(audio_utils::EffectHandle_Mutex);\n    status_t disable_l() final REQUIRES(audio_utils::EffectHandle_Mutex);\n"
            }
          ]
        }
      ],
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8cac210f_0c05b99c",
        "filename": "services/audioflinger/Effects.h",
        "patchSetId": 1
      },
      "lineNbr": 331,
      "author": {
        "id": 1491204
      },
      "writtenOn": "2024-05-24T06:31:25Z",
      "side": 1,
      "message": "This is the biggest issue: it can be either EffectHandle_Mutex or DeviceEffectProxy_Mutex (since the chaining of lock is not the same in case of device effect).\nI saw some comment on containsHapticGeneratingEffect_l for example. Is there any macro to express it rather than comment?",
      "parentUuid": "70e935b1_35731bd0",
      "range": {
        "startLine": 331,
        "startChar": 21,
        "endLine": 331,
        "endChar": 30
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bc2a1590_fcd886d5",
        "filename": "services/audioflinger/IAfEffect.h",
        "patchSetId": 1
      },
      "lineNbr": 335,
      "author": {
        "id": 1040213
      },
      "writtenOn": "2024-05-24T00:54:34Z",
      "side": 1,
      "message": "REQUIRES()",
      "range": {
        "startLine": 335,
        "startChar": 31,
        "endLine": 335,
        "endChar": 32
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "20aba0a0_6f033957",
        "filename": "services/audioflinger/IAfEffect.h",
        "patchSetId": 1
      },
      "lineNbr": 335,
      "author": {
        "id": 1491204
      },
      "writtenOn": "2024-05-24T12:24:50Z",
      "side": 1,
      "message": "partially done...",
      "parentUuid": "bc2a1590_fcd886d5",
      "range": {
        "startLine": 335,
        "startChar": 31,
        "endLine": 335,
        "endChar": 32
      },
      "revId": "fa5841e4986ae22cca03b269a3558df99d48ade0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}