{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "0c70fbcd_68d9db6a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1003259
      },
      "writtenOn": "2023-11-03T12:56:08Z",
      "side": 1,
      "message": "Mikhail, \n\nPlease review the last comment",
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d2525ff1_2be89bf3",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1003259
      },
      "writtenOn": "2023-11-03T09:01:53Z",
      "side": 1,
      "message": "this method is still unused: why is it added by this CL?",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "09e0075e_fb956b43",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1478901
      },
      "writtenOn": "2023-11-03T09:31:28Z",
      "side": 1,
      "message": "This is the original function but rename it to not confusing the usage. If it is confirmed to deprecate, then I can remove it.",
      "parentUuid": "d2525ff1_2be89bf3",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "11ae3116_218ae23d",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1003259
      },
      "writtenOn": "2023-11-03T09:46:41Z",
      "side": 1,
      "message": "Current implementation of AudioPort::clearAudioProfiles  calls AudioProfileVector ðŸ˜Š\nclearProfiles();\nhttps://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/media/libaudiofoundation/include/media/AudioPort.h;l\u003d63?q\u003dclearAudioProfiles\n\nWhen this method is called by AudioPolicyManager, the intent is to clear the dynamic profiles, not the entire profiles:\n\n\nframeworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp (4 results)\n6291:\ncheckOutputsForDevice(const device, state, outputs)\n{... device-\u003eclearAudioProfiles(); ...}\n6418:\ncheckOutputsForDevice(const device, state, outputs)\n{... profile-\u003eclearAudioProfiles(); ...}\n6450:\ncheckInputsForDevice(const device, state)\n{... device-\u003eclearAudioProfiles(); ...}\n6562:\ncheckInputsForDevice(const device, state)\n{... profile-\u003eclearAudioProfiles(); ...}\n\n If you change the method name wihtout changing the call site, you change the behavior. If you want to keep this renaming for clarity, thne you have to change AudioPort::clearAudioProfiles() and call clearDynamicProfiles() there",
      "parentUuid": "09e0075e_fb956b43",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c7cc4ed6_8abd2551",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1478901
      },
      "writtenOn": "2023-11-03T11:13:58Z",
      "side": 1,
      "message": "Yes, I know they are different behavior. I think the real problem is the design of dynamic format is changed and I\u0027m not sure what\u0027s Google\u0027s plan.\nSince the flow is changed, the original flow is treating dynamic format in AudioProfile when xml is described format with \u0027AUDIO_FORMAT_DEFAULT\u0027 and the new flow(with set_device_connected_state_v7() and get_audio_port_v7() supported by AudioHAL) is not. Then the AudioProfile::isDynamicFormat() which is checked by AudioProfileVector::clearProfiles() is not suite to the new flow.\nhttps://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/services/audiopolicy/common/managerdefinitions/src/Serializer.cpp;drc\u003deb747762bdd1889e4d65eae868f11c8cde3a8d7c;l\u003d439\n\nFor my opinion, since the new flow is always clear and get new AudioProfile when digital device is connecting. It\u0027s unnecessary to \"just clear AudioProfile with dynamic format\" but \"clear all AudioProfile\" will be more reasonable.\nhttps://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp;drc\u003dfd9ffd1d15d5d53e19a4a500cf2fc5892a10d60f;l\u003d5904",
      "parentUuid": "11ae3116_218ae23d",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ce5c9528_918111fb",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1003259
      },
      "writtenOn": "2023-11-03T12:59:24Z",
      "side": 1,
      "message": "We need to consider carefully what happens for profiles with partly dynamic audio profiles",
      "parentUuid": "c7cc4ed6_8abd2551",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "50a57ce3_a0c019c7",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1042638
      },
      "writtenOn": "2023-11-03T17:43:04Z",
      "side": 1,
      "message": "Kuowei, regarding this:\n\n\u003e the original flow is treating dynamic format in AudioProfile when xml is described format with \u0027AUDIO_FORMAT_DEFAULT\u0027\n\nDo you have examples of XML configurations which do that? I quickly checked released Google and Pixel devices, they do not seem to use this approach. Usually \"dynamic\" mix ports are left with empty profiles. Then the XML deserializer would add a dynamic profile if it finds profiles to be empty:\n\nhttps://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/services/audiopolicy/common/managerdefinitions/src/Serializer.cpp;l\u003d474;drc\u003deaf60784f41774d1f883547aa9e442f4ca37cca5\n\nSimilarly, when the profile is not fully specified in the XML, for example, the `format` attribute is left empty or contains a value that can\u0027t be parsed, then the XML deserializer was just using `AUDIO_FORMAT_DEFAULT` as a default value: https://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/services/audiopolicy/common/managerdefinitions/src/Serializer.cpp;l\u003d435;drc\u003defc6cf71445a9cee74a049e41a7970f87704c282\n\nThis conventions still remains. If we consider `get_audio_port_v7` API, it is intended for reporting profiles supported by a connected device. In this case, the profiles can\u0027t actually be dynamic, since \"dynamic\" is a placeholder which is kept until the port is populated with actual profiles via that API. I guess, this is the moment when we actually need to remove the dynamic placeholder from profiles.\n\nNow, Eric is talking about the case when a mix port contains both a dynamic placeholder and some static profiles. I think, this can occur when DSP is present in the HAL module. In this case, a mix port can be routed both to built-in devices and external devices. When an external device is connected, the \"dynamic\" part of the mix port needs to be replaced with actual profiles of the connected device.\n\nI think, to make this change with more confidence, you can try building a test case within https://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/services/audiopolicy/tests/audiopolicymanager_tests.cpp which would cover different cases of connecting external devices.\n\nYou can split out the fix for the channel masks into a separate CL, that part is well understood and doesn\u0027t require extra testing.",
      "parentUuid": "ce5c9528_918111fb",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ace3246e_952a65e4",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1478901
      },
      "writtenOn": "2023-11-06T12:06:54Z",
      "side": 1,
      "message": "I didn\u0027t notice there is default format, so I want to correct the root cause, which is, the if statement isDynamicFormat() / hasValidFormat() in AudioProfileVector::clearProfiles() will never be true when the format is AUDIO_FORMAT_DEFAULT.\nhttps://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/media/libaudiofoundation/AudioProfile.cpp;drc\u003d60c3258770b1ce3ce5bbdcff3c4a87c8f996b92f;l\u003d250\n\nThen, I want to confirm following questions and will update CL later.\n1. Is it better to remove hasValidFormat() check in AudioProfileVector::clearProfiles()?\n2. Since this issue need to fix those 2 symptoms, do I still need to separate 2 CLs for them?\n3. Is the new testcase necessary for this CL?",
      "parentUuid": "50a57ce3_a0c019c7",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "49c59b9b_f2b5bfa6",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1478901
      },
      "writtenOn": "2023-11-06T13:55:10Z",
      "side": 1,
      "message": "To clarify more specifically.\nIf the format is AUDIO_FORMAT_DEFAULT, then it\u0027s dynamic format and has no valid format.\nIf the format is imported from getAudioPort(), it\u0027s not dynamic format and has valid format.\nhttps://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp;l\u003d6301;drc\u003d60c3258770b1ce3ce5bbdcff3c4a87c8f996b92f;bpv\u003d1;bpt\u003d1",
      "parentUuid": "ace3246e_952a65e4",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c79ea54c_42f250ef",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1003259
      },
      "writtenOn": "2023-11-06T15:16:08Z",
      "side": 1,
      "message": "What I want to make sure is that we preserve the behavior that a dynamic audio profile entry remains in an AudioPort after the a device is disconnected and IOProfile::clearAudioProfiles() is called. This entry must remain to indicate that this audio port has dynamic AudioProfiles and that actual profiles must be created when a device is connected.\nIf we just clear the whole profile list then we will remove this dynamic profile that must survive a device disconnection.",
      "parentUuid": "49c59b9b_f2b5bfa6",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "14f95960_4d75daf7",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1042638
      },
      "writtenOn": "2023-11-06T23:49:15Z",
      "side": 1,
      "message": "Kuowei, I think the original logic actually has one more possible kind for the format. Unfortunately, this might not be clear due to overloaded usage of the \"dynamic\" word. You have listed two kinds:\n\n\u003e 1. If the format is AUDIO_FORMAT_DEFAULT, then it\u0027s dynamic format and has no valid format.\n\u003e 2. If the format is imported from getAudioPort(), it\u0027s not dynamic format and has valid format.\n\nWe should clarify their names better:\n\n1. Is a \"dynamic format placeholder\". It indicates to the APM that this mix port may receive actual formats once an external device is connected. It is true that it\u0027s not a \"valid\" format.\n\n2. Is the actual \"dynamic\" format. It is the format which was added because the profile has the placeholder and an external device was connected. This is a \"valid\" format.\n\n3. And there is another \"valid\" formatâ€”any format which was specified upfront (statically via the configuration) and must not be affected by connection of external devices.\n\nThus, the condition `(*it)-\u003eisDynamicFormat() \u0026\u0026 (*it)-\u003ehasValidFormat()` is true only for the 2nd kind of formats. These have to be removed when an external device gets disconnected. The removal must not affect formats of the kind 1. and 3.\n\nFrom the programmatic POV, the kind 1. is identified by having the `DEFAULT` format. The kind 2. by the fact that it has some of `isDynamic{Format|Channels|Rate}` flags set (for example, from this code: https://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/media/libaudiofoundation/include/media/AudioProfile.h;l\u003d70;drc\u003d60c3258770b1ce3ce5bbdcff3c4a87c8f996b92f). The kind 3. is the one with a non-default format and none of those flags being set.",
      "parentUuid": "c79ea54c_42f250ef",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e6295eca_c9962859",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1478901
      },
      "writtenOn": "2023-11-09T09:36:05Z",
      "side": 1,
      "message": "\u003e We should clarify their names better:\n\u003e \n\u003e 1. Is a \"dynamic format placeholder\". It indicates to the APM that this mix port may receive actual formats once an external device is connected. It is true that it\u0027s not a \"valid\" format.\n\u003e \n\u003e 2. Is the actual \"dynamic\" format. It is the format which was added because the profile has the placeholder and an external device was connected. This is a \"valid\" format.\n\u003e \n\u003e 3. And there is another \"valid\" formatâ€”any format which was specified upfront (statically via the configuration) and must not be affected by connection of external devices.\n\nBased on the conclusion, I believe the profiles from getAudioPort() should be set as dynamic.",
      "parentUuid": "14f95960_4d75daf7",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0948890c_d5c3e932",
        "filename": "media/libaudiofoundation/include/media/AudioProfile.h",
        "patchSetId": 6
      },
      "lineNbr": 132,
      "author": {
        "id": 1042638
      },
      "writtenOn": "2023-11-09T17:04:49Z",
      "side": 1,
      "message": "I tend to agree. Prior to your patch, it seems that the behavior on importing profiles is inconsistent between mix ports and device ports. Updating profiles of a mix port happens via `IOProfile::importAudioPort` which correctly sets \"dynamic\" flags: https://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/services/audiopolicy/common/managerdefinitions/src/IOProfile.cpp;l\u003d209;drc\u003d4e0deaa2d05fbda3fa32ce892ba1debc3f3a4158 (via `addDynamicProfileAndSort`). However, this logic is missing when importing a device port via `AudioPort::importAudioPort`, and that is what this CL is fixing. Perhaps, it wasn\u0027t a big problem because for device ports there should be no situation when there is a mix of static and dynamic profiles.\n\nThank you so much for thinking this problem out!",
      "parentUuid": "e6295eca_c9962859",
      "range": {
        "startLine": 132,
        "startChar": 17,
        "endLine": 132,
        "endChar": 37
      },
      "revId": "d6581302c1279ce02feb230c5982d4352aa039c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}