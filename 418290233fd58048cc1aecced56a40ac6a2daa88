{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "e96b4766_c48d55df",
        "filename": "media/module/extractors/mkv/MatroskaExtractor.cpp",
        "patchSetId": 1
      },
      "lineNbr": 2281,
      "author": {
        "id": 1643005
      },
      "writtenOn": "2024-04-03T09:23:57Z",
      "side": 0,
      "message": "This method is aiming to pick a thumbnail that \u0027represents\u0027 the media (as [documented on `MediaMetadataRetriever.getFrameAtTime`](https://developer.android.com/reference/android/media/MediaMetadataRetriever#getFrameAtTime%28%29)). In many cases, naively selecting the first keyframe will result in a black or mostly empty frame (e.g. during opening credits or similar). This `20` threshold, combined with the `max(size)` logic below, is here as a heuristic to ensure we pick the largest keyframe (as a proxy for \u0027most interesting\u0027) from the first 20.\n\nYou can see the same logic is [implemented for MP4 files too](https://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/media/module/extractors/mp4/SampleTable.cpp;l\u003d911-937;drc\u003d2e87c835abea90b0cf61b42dc9aa8a882f2ef5aa).\n\nThe change proposed here would remove this heuristic and always select the first keyframe, which risks a reduction in quality of the result - it\u0027s very likely that more videos will be thumbnail\u0027d with ambiguous/unrepresentative thumbnails.\n\nAs such, i\u0027m afraid we\u0027re not going to accept this change in its current form.",
      "range": {
        "startLine": 2281,
        "startChar": 0,
        "endLine": 2281,
        "endChar": 39
      },
      "revId": "418290233fd58048cc1aecced56a40ac6a2daa88",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "76ef5aa3_8bcb962a",
        "filename": "media/module/extractors/mkv/MatroskaExtractor.cpp",
        "patchSetId": 1
      },
      "lineNbr": 2281,
      "author": {
        "id": 1955441
      },
      "writtenOn": "2024-04-03T09:42:21Z",
      "side": 0,
      "message": "I see what you mean, but as you can see in the log, this method takes a long time(https://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/media/module/extractors/mkv/MatroskaExtractor.cpp;drc\u003d13412bb94816e57e3a2de1018c65192f5b1a7261;l\u003d341), how can we solve the performance problem?",
      "parentUuid": "e96b4766_c48d55df",
      "range": {
        "startLine": 2281,
        "startChar": 0,
        "endLine": 2281,
        "endChar": 39
      },
      "revId": "418290233fd58048cc1aecced56a40ac6a2daa88",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7137704a_dc1580e7",
        "filename": "media/module/extractors/mkv/MatroskaExtractor.cpp",
        "patchSetId": 1
      },
      "lineNbr": 2281,
      "author": {
        "id": 1643005
      },
      "writtenOn": "2024-04-03T10:40:19Z",
      "side": 0,
      "message": "Have you dug in deeper to understand why that method takes too long? Do you see the same performance issues with MP4 files of a similar size? If not, it suggests that maybe the MP4 implementation is able to read the keyframe sizes while reading less data than this Matroska implementation.\n\nYou mention that the performance is slower on larger files. This surprises me, since in all cases we only need to read the first 20 GoPs - so why would a larger file be slower (assuming both files have \u003e20 keyframes)?\n\nHow much of a performance improvement do you see with this change? You\u0027ve mentioned you observe 6500ms with a 200MB video before this change. How long does the method take after this change?",
      "parentUuid": "76ef5aa3_8bcb962a",
      "range": {
        "startLine": 2281,
        "startChar": 0,
        "endLine": 2281,
        "endChar": 39
      },
      "revId": "418290233fd58048cc1aecced56a40ac6a2daa88",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5b91c59b_41ea0c62",
        "filename": "media/module/extractors/mkv/MatroskaExtractor.cpp",
        "patchSetId": 1
      },
      "lineNbr": 2281,
      "author": {
        "id": 1955441
      },
      "writtenOn": "2024-04-07T07:51:04Z",
      "side": 0,
      "message": "1.I debug further and find that Matroska takes more time to find the first 20 key frames than MP4, because now the logic is to continue to advance, until the first 20 key frames are traversed, which takes about 1000-2000 iterations and takes 2-4s(findThumbnails()).\n\n2.This is because this file(phfx_4KHD_VP9TestFootage-NO-AUDIO.webm) is special, it has only one key frame, so the whole file needs to be traversed until EOS, so it takes longer.\n\n3.getFrameAtTime() cost 364ms, findThumbnails() cost 2ms with this change",
      "parentUuid": "7137704a_dc1580e7",
      "range": {
        "startLine": 2281,
        "startChar": 0,
        "endLine": 2281,
        "endChar": 39
      },
      "revId": "418290233fd58048cc1aecced56a40ac6a2daa88",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6e443c77_e3593e54",
        "filename": "media/module/extractors/mkv/MatroskaExtractor.cpp",
        "patchSetId": 1
      },
      "lineNbr": 2281,
      "author": {
        "id": 1546599
      },
      "writtenOn": "2024-04-07T16:01:00Z",
      "side": 0,
      "message": "Because the first key frame is chosen as a thumbnail, it may result in a blank frame for many clips.\nGiven that it is not common for a file with 2000 frames to have a single key frame, I am not sure if choosing this approach of returning first key frame is a good idea..\n\nInstead of this, would it be acceptable to limit the loop to say 600 iterations? (i.e. 20 seconds of video at 30fps)?",
      "parentUuid": "5b91c59b_41ea0c62",
      "range": {
        "startLine": 2281,
        "startChar": 0,
        "endLine": 2281,
        "endChar": 39
      },
      "revId": "418290233fd58048cc1aecced56a40ac6a2daa88",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2cebff5c_ebe03a61",
        "filename": "media/module/extractors/mkv/MatroskaExtractor.cpp",
        "patchSetId": 1
      },
      "lineNbr": 2281,
      "author": {
        "id": 1955441
      },
      "writtenOn": "2024-04-08T03:40:11Z",
      "side": 0,
      "message": "I\u0027ve changed the number of iterations to 600.",
      "parentUuid": "6e443c77_e3593e54",
      "range": {
        "startLine": 2281,
        "startChar": 0,
        "endLine": 2281,
        "endChar": 39
      },
      "revId": "418290233fd58048cc1aecced56a40ac6a2daa88",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3629a621_838e0810",
        "filename": "media/module/extractors/mkv/MatroskaExtractor.cpp",
        "patchSetId": 1
      },
      "lineNbr": 2281,
      "author": {
        "id": 1643005
      },
      "writtenOn": "2024-04-08T09:49:47Z",
      "side": 0,
      "message": "Thanks for the extra detail on the fact the video only has one keyframe. It looks like the MP4 extraction logic has a [nice look-up table of sync samples](https://cs.android.com/android/platform/superproject/main/+/main:frameworks/av/media/module/extractors/mp4/include/SampleTable.h;l\u003d141;drc\u003d3d19fbcc09b1b44928639b06cd0b88f735cd988d) derived from the `stss` box. A quick scan through the [Matroska spec](https://www.matroska.org/technical/elements.html) doesn\u0027t reveal an equivalent source of this metadata (apart from the `Cues` element, which is a) optional and b) doesn\u0027t contain **all** sync samples, just some to enable faster seeking). So I don\u0027t think there\u0027s any option except to loop through frame-by-frame, checking each one if it\u0027s a keyframe.\n\n\n----\n\n\u003e Instead of this, would it be acceptable to limit the loop to say 600 iterations? (i.e. 20 seconds of video at 30fps)?\n\n@hmahendrakar@google.com Instead of proxying duration, we could just check duration directly? By comparing the `BlockIterator.blockTimeUs()` between the first block and the one we\u0027re currently inspecting.\n\n----\n\n\u003e I\u0027ve changed the number of iterations to 600.\n\n@guochuang@xiaomi.corp-partner.google.com The new code now **always** looks at 600 frames, which may result in looking at **more** than 20 key frames if the input video has dense key frames, which in that case makes it less efficient than before. I think you need to track \u0027number of keyframes considered for `maxBlockSize`\u0027 and \u0027total number of frames (or duration) inspected\u0027 separately. The first should remain capped at 20, and an additional loop control should exit when the second reaches 600 or 20s.",
      "parentUuid": "2cebff5c_ebe03a61",
      "range": {
        "startLine": 2281,
        "startChar": 0,
        "endLine": 2281,
        "endChar": 39
      },
      "revId": "418290233fd58048cc1aecced56a40ac6a2daa88",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}