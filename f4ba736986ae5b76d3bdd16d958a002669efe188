{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "66e90bc0_3e916bc8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 9
      },
      "lineNbr": 0,
      "author": {
        "id": 1133568
      },
      "writtenOn": "2024-02-12T19:43:48Z",
      "side": 1,
      "message": "PS9 changes the approach: see also depends-on patch https://android-review.googlesource.com/c/platform/hardware/interfaces/+/2959146\n\nIn this approach:\n* remote submix AIDL HAL doesn\u0027t advertise new DIRECT/IEC958_NONAUDIO mix ports. It is now consistent with the remote submix HIDL HAL approach which simply adds 192kHz support.\n* retries for opening remote submix AIDL HAL without DIRECT/IEC958_NONAUDIO flags is added to Hal2AidlMapper adapter.\n\nThis results in a overall simpler topic.\n\nUnfortunately, with these changes, the following tests are still failing\n* audiorouting_tests\n* CtsVirtualDevicesTestCases --test-filter\u003d\".*VirtualAudioTest.*\"\n\nHowever, as the introduction of remote submix AIDL direct ports was further complicating the implementation and debug, I think this is overall a better approach and it should hopefully be easier to reason about and fix.",
      "revId": "f4ba736986ae5b76d3bdd16d958a002669efe188",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9cf96102_493aa64a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 9
      },
      "lineNbr": 0,
      "author": {
        "id": 1042638
      },
      "writtenOn": "2024-02-13T00:53:04Z",
      "side": 1,
      "message": "Being consistent with HIDL is certainly a good property.",
      "parentUuid": "66e90bc0_3e916bc8",
      "revId": "f4ba736986ae5b76d3bdd16d958a002669efe188",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "32c0e3bc_45c08575",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 9
      },
      "lineNbr": 0,
      "author": {
        "id": 1133568
      },
      "writtenOn": "2024-02-15T13:01:43Z",
      "side": 1,
      "message": "AudioTrackTest#DefaultRoutingTest failure mode on ToT is reproducible simply by changing the sample rate in the test from 48kHz to 16kHz (or any other sample rate supported by the AIDL remote submix profile other than 48kHz).\n\nAPM startInput calls setDeviceConnectionStateInt for AUDIO_DEVICE_OUT_REMOTE_SUBMIX and this opens an output on remote submix. The problematic call sequence is\n\nsetDeviceConnectionInt -\u003e checkOutputsForDevice -\u003e openOutputWithProfileAndDevice (using profile including higher sample rate, like 16kHz AND 48kHz, than the sample rate of the paired input request (e.g. 16kHz)) -\u003e the SwAudioOutputDescriptor is constructed with the profile and its mPolicyAudioPort is picked in PolicyAudioPort::pickAudioProfile according to rules which mean the for the non direct output, the maximum sampling rate is used (48 kHz in this instance). This leads to an SwAudioOutputDescriptor open using this sample rate and this fails, because in ModuleRemoteSubmix setAudioPortConfig the remote end (input side) is active and the config is set to 16kHz, but this eventually leads to a 48kHz mix port to 16kHz device port patch request which fails the checkAudioPatchEndpointsMatch check\n\nTo fix this for \n\n```\n02-15 22:38:43.318   460   460 I AudioFlinger: openOutput() this 0xf12c2fe0, module 18 Device AUDIO_DEVICE_OUT_REMOTE_SUBMIX, @:0, SamplingRate 48000, Format 0x000001, Channels 0x3, flags 0\n02-15 22:38:43.318   460   460 D DeviceHalAidl: 0xf12c5fb0 DeviceHalAidl::openOutputStream\n02-15 22:38:43.318   460   460 D Hal2AidlMapper: 0xf12c6028 prepareToOpenStream: handle 45, device AudioDevice{type: AudioDeviceDescription{type: OUT_SUBMIX, connection: virtual}, address: AudioDeviceAddress{id: 0}}, flags AudioIoFlags{output: 0}, source SYS_RESERVED_INVALID, config AudioConfig{base: AudioConfigBase{sampleRate: 48000, channelMask: AudioChannelLayout{layoutMask: 3}, format: AudioFormatDescription{type: PCM, pcm: INT_16_BIT, encoding: }}, offloadInfo: AudioOffloadInfo{base: AudioConfigBase{sampleRate: 0, channelMask: AudioChannelLayout{none: 0}, format: AudioFormatDescription{type: DEFAULT, pcm: DEFAULT, encoding: }}, streamType: VOICE_CALL, bitRatePerSecond: 0, durationUs: 0, hasVideo: false, isStreaming: false, bitWidth: 16, offloadBufferSize: 0, usage: UNKNOWN, encapsulationMode: NONE, contentId: 0, syncId: 0}, frameCount: 0}, mix port config AudioPortConfig{id: 0, portId: 0, sampleRate: (null), channelMask: (null), format: (null), gain: (null), flags: (null), ext: AudioPortExt{unspecified: false}}\n02-15 22:38:43.318   381   381 D AHAL_Module: setAudioPortConfigImpl: requested AudioPortConfig{id: 0, portId: 16, sampleRate: Int{value: 48000}, channelMask: AudioChannelLayout{layoutMask: 3}, format: AudioFormatDescription{type: PCM, pcm: INT_16_BIT, encoding: }, gain: (null), flags: (null), ext: AudioPortExt{unspecified: false}}\n02-15 22:38:43.318   381   381 D AHAL_ModuleRemoteSubmix: setAudioPortConfig: suggesting port config from the remote end.\n02-15 22:38:43.318   381   381 W AHAL_Module: setAudioPortConfigImpl: requested sample rate 48000 is not supported for the format AudioFormatDescription{type: PCM, pcm: INT_16_BIT, encoding: } by the port 16\n02-15 22:38:43.318   381   381 D AHAL_Module: setAudioPortConfigImpl: not applied; existing config ? 0; requested is valid? 0, fully specified? 0\n02-15 22:38:43.318   381   381 D AHAL_Module: setAudioPortConfigImpl: requested AudioPortConfig{id: 0, portId: 16, sampleRate: Int{value: 16000}, channelMask: AudioChannelLayout{layoutMask: 3}, format: AudioFormatDescription{type: PCM, pcm: INT_16_BIT, encoding: }, gain: (null), flags: AudioIoFlags{output: 0}, ext: AudioPortExt{device: AudioPortDeviceExt{device: AudioDevice{type: AudioDeviceDescription{type: OUT_SUBMIX, connection: virtual}, address: AudioDeviceAddress{id: 0}}, flags: 0, encodedFormats: [], encapsulationModes: 0, encapsulationMetadataTypes: 0}}}\n02-15 22:38:43.318   381   381 D AHAL_ModuleRemoteSubmix: setAudioPortConfig: suggesting port config from the remote end.\n02-15 22:38:43.318   381   381 D AHAL_Module: setAudioPortConfigImpl: created new port config AudioPortConfig{id: 17, portId: 16, sampleRate: Int{value: 16000}, channelMask: AudioChannelLayout{layoutMask: 3}, format: AudioFormatDescription{type: PCM, pcm: INT_16_BIT, encoding: }, gain: (null), flags: AudioIoFlags{output: 0}, ext: AudioPortExt{device: AudioPortDeviceExt{device: AudioDevice{type: AudioDeviceDescription{type: OUT_SUBMIX, connection: virtual}, address: AudioDeviceAddress{id: 0}}, flags: 0, encodedFormats: [], encapsulationModes: 0, encapsulationMetadataTypes: 0}}}\n02-15 22:38:43.318   381   381 D AHAL_Module: setAudioPortConfigImpl: requested AudioPortConfig{id: 0, portId: 3, sampleRate: Int{value: 48000}, channelMask: AudioChannelLayout{layoutMask: 3}, format: AudioFormatDescription{type: PCM, pcm: INT_16_BIT, encoding: }, gain: (null), flags: AudioIoFlags{output: 0}, ext: AudioPortExt{mix: AudioPortMixExt{handle: 45, usecase: AudioPortMixExtUseCase{unspecified: false}, maxOpenStreamCount: 0, maxActiveStreamCount: 0, recommendedMuteDurationMs: 0}}}\n02-15 22:38:43.318   381   381 D AHAL_Module: setAudioPortConfigImpl: created new port config AudioPortConfig{id: 18, portId: 3, sampleRate: Int{value: 48000}, channelMask: AudioChannelLayout{layoutMask: 3}, format: AudioFormatDescription{type: PCM, pcm: INT_16_BIT, encoding: }, gain: (null), flags: AudioIoFlags{output: 0}, ext: AudioPortExt{mix: AudioPortMixExt{handle: 45, usecase: AudioPortMixExtUseCase{unspecified: false}, maxOpenStreamCount: 10, maxActiveStreamCount: 10, recommendedMuteDurationMs: 0}}}\n02-15 22:38:43.318   381   381 D AHAL_Module: setAudioPatch: requested patch AudioPatch{id: 0, sourcePortConfigIds: [18], sinkPortConfigIds: [17], minimumStreamBufferSizeFrames: 0, latenciesMs: []}\n02-15 22:38:43.318   381   381 E AHAL_ModuleRemoteSubmix: checkAudioPatchEndpointsMatch: mismatch port configuration, source\u003dAudioPortConfig{id: 18, portId: 3, sampleRate: Int{value: 48000}, channelMask: AudioChannelLayout{layoutMask: 3}, format: AudioFormatDescription{type: PCM, pcm: INT_16_BIT, encoding: }, gain: (null), flags: AudioIoFlags{output: 0}, ext: AudioPortExt{mix: AudioPortMixExt{handle: 45, usecase: AudioPortMixExtUseCase{unspecified: false}, maxOpenStreamCount: 10, maxActiveStreamCount: 10, recommendedMuteDurationMs: 0}}}, sink\u003dAudioPortConfig{id: 17, portId: 16, sampleRate: Int{value: 16000}, channelMask: AudioChannelLayout{layoutMask: 3}, format: AudioFormatDescription{type: PCM, pcm: INT_16_BIT, encoding: }, gain: (null), flags: AudioIoFlags{output: 0}, ext: AudioPortExt{device: AudioPortDeviceExt{device: AudioDevice{type: AudioDeviceDescription{type: OUT_SUBMIX, connection: virtual}, address: AudioDeviceAddress{id: 0}}, flags: 0, encodedFormats: [], encapsulationModes: 0, encapsulationMetadataTypes: 0}}}\n02-15 22:38:43.318   381   381 E AHAL_Module: Function: setAudioPatch Line: 969 Failed \n02-15 22:38:43.318   460   460 E Hal2AidlMapper: Function: findOrCreatePatch Line: 296 Failed \n02-15 22:38:43.318   460   460 E Hal2AidlMapper: Function: prepareToOpenStreamHelper Line: 851 Failed \n02-15 22:38:43.318   460   460 E DeviceHalAidl: Function: openOutputStream Line: 447 Failed \n02-15 22:38:43.319   381   381 D AHAL_Module: resetAudioPortConfig: erased port config 18\n02-15 22:38:43.319   381   381 D AHAL_Module: resetAudioPortConfig: erased port config 17\n02-15 22:38:43.319   460   460 I AudioHwDevice: openOutputStream(), HAL returned sampleRate 48000, format 0x1, channelMask 0x3, status -38\n02-15 22:38:43.319   460   460 E APM_AudioPolicyManager: openOutputWithProfileAndDevice failed to open output -19\n02-15 22:38:43.319   460   460 W APM_AudioPolicyManager: checkOutputsForDevice() could not open output for device 8000\n02-15 22:38:43.319   460   460 W APM_AudioPolicyManager: checkOutputsForDevice(): No output available for device 8000\n```",
      "parentUuid": "9cf96102_493aa64a",
      "revId": "f4ba736986ae5b76d3bdd16d958a002669efe188",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "159aac00_f9ac2642",
        "filename": "media/libaudiohal/impl/Hal2AidlMapper.cpp",
        "patchSetId": 9
      },
      "lineNbr": 350,
      "author": {
        "id": 1042638
      },
      "writtenOn": "2024-02-13T00:52:07Z",
      "side": 1,
      "message": "`DIRECT` needs to be scoped to remote submix mix ports only. I think, allowing to drop it for any request is not a good idea.",
      "range": {
        "startLine": 350,
        "startChar": 12,
        "endLine": 350,
        "endChar": 35
      },
      "revId": "f4ba736986ae5b76d3bdd16d958a002669efe188",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ca34205d_525630b2",
        "filename": "media/libaudiohal/impl/Hal2AidlMapper.cpp",
        "patchSetId": 9
      },
      "lineNbr": 350,
      "author": {
        "id": 1133568
      },
      "writtenOn": "2024-02-14T02:32:26Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "159aac00_f9ac2642",
      "range": {
        "startLine": 350,
        "startChar": 12,
        "endLine": 350,
        "endChar": 35
      },
      "revId": "f4ba736986ae5b76d3bdd16d958a002669efe188",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}